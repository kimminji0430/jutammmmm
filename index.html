<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>우리 동네 경로 안내</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }
    .top-buttons {
      position: absolute; top: 10px; left: 10px; z-index: 1000;
    }
    #progress-box {
      position: absolute; top: 10px; right: 10px; z-index: 1000;
      background: rgba(255, 255, 255, 0.9); padding: 8px 12px;
      border-radius: 8px; font-size: 14px; font-weight: bold;
    }
    button {
      margin: 4px; padding: 10px 15px; font-size: 16px;
      border: none; border-radius: 5px; cursor: pointer;
    }
    #resetBtn { background-color: #c62828; color: white; }
    #sensorBtn { background-color: #2e7d32; color: white; }
    #compass-container {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1001;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="top-buttons">
    <button id="sensorBtn">📱 방향 센서 활성화</button>
    <button id="resetBtn" onclick="resetMap()">🔄 초기화</button>
  </div>
  <div id="progress-box">진행률: -</div>
  <div id="compass-container">
    <canvas id="compassCanvas" width="200" height="200"></canvas>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let fixedTargetAngle = null;
    let deviceHeading = null;
    let directionMatched = false;

    function speak(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'ko-KR';
      speechSynthesis.speak(utterance);
    }

    function calculateBearing(lat1, lon1, lat2, lon2) {
      const toRad = deg => deg * Math.PI / 180;
      const toDeg = rad => rad * 180 / Math.PI;
      const dLon = toRad(lon2 - lon1);
      const y = Math.sin(dLon) * Math.cos(toRad(lat2));
      const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
                Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon);
      return (toDeg(Math.atan2(y, x)) + 360) % 360;
    }

    function drawCompass(targetAngle, tolerance, currentAngle) {
      const canvas = document.getElementById("compassCanvas");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, 200, 200);
      const centerX = 100, centerY = 100, radius = 90;

      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
      ctx.strokeStyle = "#555";
      ctx.lineWidth = 2;
      ctx.stroke();

      const startRad = ((targetAngle - tolerance + 360) % 360) * Math.PI / 180;
      const endRad = ((targetAngle + tolerance + 360) % 360) * Math.PI / 180;

      ctx.beginPath();
      ctx.moveTo(centerX, centerY);
      ctx.arc(centerX, centerY, radius, startRad, endRad);
      ctx.lineTo(centerX, centerY);
      ctx.fillStyle = "rgba(0, 255, 0, 0.3)";
      ctx.fill();

      const angleRad = (currentAngle - 90) * Math.PI / 180;
      const x = centerX + radius * Math.cos(angleRad);
      const y = centerY + radius * Math.sin(angleRad);

      ctx.beginPath();
      ctx.moveTo(centerX, centerY);
      ctx.lineTo(x, y);
      ctx.strokeStyle = "red";
      ctx.lineWidth = 4;
      ctx.stroke();
    }

    function updateCompassAlways() {
      if (deviceHeading === null || fixedTargetAngle === null) return;
      drawCompass(fixedTargetAngle, 30, deviceHeading);
      const diff = Math.abs(fixedTargetAngle - deviceHeading);
      const angleDiff = Math.min(diff, 360 - diff);
      if (angleDiff > 30) {
        if (directionMatched) {
          speak("방향이 틀렸습니다. 화살표를 초록색 안으로 돌려주세요.");
          directionMatched = false;
        }
      } else {
        if (!directionMatched) {
          speak("방향이 맞았습니다. 계속 이동하세요.");
          directionMatched = true;
        }
      }
    }

    function handleOrientation(event) {
      if (event.webkitCompassHeading !== undefined) deviceHeading = event.webkitCompassHeading;
      else if (event.alpha !== null) deviceHeading = 360 - event.alpha;
    }

    function requestSensorPermission() {
      if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission().then(state => {
          if (state === 'granted') window.addEventListener("deviceorientation", handleOrientation);
        }).catch(console.error);
      } else window.addEventListener("deviceorientation", handleOrientation);
    }

    document.getElementById("sensorBtn").addEventListener("click", requestSensorPermission);

    // 예시: 경로 방향 설정 (향후 경로에 따라 갱신 필요)
    fixedTargetAngle = 90; // 동쪽 방향 (예시 값)

    setInterval(updateCompassAlways, 3000);
  </script>
</body>
</html>
